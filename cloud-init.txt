#cloud-config
package_upgrade: true
packages:
  - nginx
  - htop
  - curl
  - wget
  - git
  - unzip
  - fail2ban
  - ufw

# Configurar usuario (las claves SSH se manejan por Terraform)
users:
  - name: ${admin_username}
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys: []  # Las claves se configuran automÃ¡ticamente por Terraform

# Deshabilitar autenticaciÃ³n por contraseÃ±a para mayor seguridad
ssh_pwauth: false

# Configurar firewall y servicios
runcmd:
  # Configurar UFW (firewall)
  - ufw allow ssh
  - ufw allow http
  - ufw allow https
  - ufw --force enable
  
  # Configurar fail2ban para protecciÃ³n SSH
  - systemctl enable fail2ban
  - systemctl start fail2ban
  
  # Configurar Nginx
  - systemctl enable nginx
  - systemctl start nginx
  - echo "<h1>Â¡VM de Terraform funcionando con SSH Keys!</h1><p>ğŸ” AutenticaciÃ³n SSH segura activada</p><p>ğŸŒ IP PÃºblica: $(curl -s http://checkip.amazonaws.com)</p><p>ğŸ“… Fecha de despliegue: $(date)</p><p>ğŸ‘¤ Usuario: ${admin_username}</p><p>ğŸ·ï¸ VM gestionada por Terraform con mÃ³dulos</p>" > /var/www/html/index.html
  
  # Configurar SSH para mayor seguridad
  - sed -i 's/#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
  - sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
  - systemctl restart sshd
  
  # Configurar fail2ban para SSH
  - cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
  - systemctl restart fail2ban

final_message: "âœ… VM configurada correctamente con autenticaciÃ³n SSH. Usuario: ${admin_username}"
